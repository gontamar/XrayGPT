 Now let me show you the exact code connection flow for how registry.get_builder_class(name) returns the builder      â”‚
â”‚ classes:                                                                                                             â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚                                  ğŸ”— Exact Code Connection: Registry Builder Lookup                                   â”‚
â”‚                                                                                                                      â”‚
â”‚                                    ğŸ“ STEP 1: Registration Phase (During Import)                                     â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚  ğŸ“ xraygpt/datasets/builders/image_text_pair_builder.py                                                             â”‚
â”‚                                                                                                                      â”‚
â”‚  # Line 4: Import registry                                                                                           â”‚
â”‚  from xraygpt.common.registry import registry                                                                        â”‚
â”‚                                                                                                                      â”‚
â”‚  # Line 10-11: Register MIMICBuilder                                                                                 â”‚
â”‚  @registry.register_builder("mimic")                                                                                 â”‚
â”‚  class MIMICBuilder(BaseDatasetBuilder):                                                                             â”‚
â”‚      # This decorator calls registry.register_builder("mimic")                                                       â”‚
â”‚      # which stores: mapping["builder_name_mapping"]["mimic"] = MIMICBuilder                                         â”‚
â”‚                                                                                                                      â”‚
â”‚  # Line 47-48: Register OpenIBuilder                                                                                 â”‚
â”‚  @registry.register_builder("openi")                                                                                 â”‚
â”‚  class OpenIBuilder(BaseDatasetBuilder):                                                                             â”‚
â”‚      # This decorator calls registry.register_builder("openi")                                                       â”‚
â”‚      # which stores: mapping["builder_name_mapping"]["openi"] = OpenIBuilder                                         â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚                                        ğŸ“ STEP 2: Registry Storage Mechanism                                         â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚  ğŸ“ xraygpt/common/registry.py                                                                                       â”‚
â”‚                                                                                                                      â”‚
â”‚  # Line 21-50: register_builder decorator                                                                            â”‚
â”‚  @classmethod                                                                                                        â”‚
â”‚  def register_builder(cls, name):                                                                                    â”‚
â”‚      def wrap(builder_cls):                                                                                          â”‚
â”‚          # Line 47: Store in mapping                                                                                 â”‚
â”‚          cls.mapping["builder_name_mapping"][name] = builder_cls                                                     â”‚
â”‚          return builder_cls                                                                                          â”‚
â”‚      return wrap                                                                                                     â”‚
â”‚                                                                                                                      â”‚
â”‚  # Internal storage after registration:                                                                              â”‚
â”‚  # cls.mapping["builder_name_mapping"] = {                                                                           â”‚
â”‚  #     "mimic": MIMICBuilder,                                                                                        â”‚
â”‚  #     "openi": OpenIBuilder                                                                                         â”‚
â”‚  # }                                                                                                                 â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚                                      ğŸ“ STEP 3: Lookup Phase (During Training)                                       â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚  ğŸ“ xraygpt/tasks/base_task.py                                                                                       â”‚
â”‚                                                                                                                      â”‚
â”‚  # Line 57: Get builder class by name                                                                                â”‚
â”‚  builder = registry.get_builder_class(name)(dataset_config)                                                          â”‚
â”‚  #          â†“                                                                                                        â”‚
â”‚  #          ğŸ”— CALLS: registry.get_builder_class(name)                                                               â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚                                         ğŸ“ STEP 4: Registry Lookup Mechanism                                         â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚  ğŸ“ xraygpt/common/registry.py                                                                                       â”‚
â”‚                                                                                                                      â”‚
â”‚  # Line 231-232: get_builder_class method                                                                            â”‚
â”‚  @classmethod                                                                                                        â”‚
â”‚  def get_builder_class(cls, name):                                                                                   â”‚
â”‚      return cls.mapping["builder_name_mapping"].get(name, None)                                                      â”‚
â”‚      #      â†“                                                                                                        â”‚
â”‚      #      ğŸ”— RETURNS:                                                                                              â”‚
â”‚      #         - If name="mimic" â†’ returns MIMICBuilder class                                                        â”‚
â”‚      #         - If name="openi" â†’ returns OpenIBuilder class                                                        â”‚
â”‚      #         - If name not found â†’ returns None                                                                    â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚                                        ğŸ“ STEP 5: Complete Flow Visualization                                        â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚  # REGISTRATION FLOW (happens during import):                                                                        â”‚
â”‚  train.py                                                                                                            â”‚
â”‚  â”œâ”€â”€ Line 27: from xraygpt.datasets.builders import *                                                                â”‚
â”‚  â”‚   â””â”€â”€ ğŸ”— IMPORTS: xraygpt/datasets/builders/image_text_pair_builder.py                                            â”‚
â”‚  â”‚       â”œâ”€â”€ Line 10: @registry.register_builder("mimic")                                                            â”‚
â”‚  â”‚       â”‚   â””â”€â”€ ğŸ”— STORES: registry.mapping["builder_name_mapping"]["mimic"] = MIMICBuilder                         â”‚
â”‚  â”‚       â””â”€â”€ Line 47: @registry.register_builder("openi")                                                            â”‚
â”‚  â”‚           â””â”€â”€ ğŸ”— STORES: registry.mapping["builder_name_mapping"]["openi"] = OpenIBuilder                         â”‚
â”‚                                                                                                                      â”‚
â”‚  # LOOKUP FLOW (happens during training):                                                                            â”‚
â”‚  xraygpt/tasks/base_task.py                                                                                          â”‚
â”‚  â””â”€â”€ Line 57: builder = registry.get_builder_class(name)(dataset_config)                                             â”‚
â”‚      â”œâ”€â”€ ğŸ”— CALLS: registry.get_builder_class("mimic")                                                               â”‚
â”‚      â”‚   â””â”€â”€ ğŸ”— RETURNS: MIMICBuilder class from mapping["builder_name_mapping"]["mimic"]                            â”‚
â”‚      â”‚                                                                                                               â”‚
â”‚      â””â”€â”€ ğŸ”— THEN: MIMICBuilder(dataset_config)                                                                       â”‚
â”‚          â””â”€â”€ ğŸ”— CREATES: MIMICBuilder instance                                                                       â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚                                         ğŸ“ STEP 6: The name Parameter Source                                         â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚  ğŸ“ xraygpt/tasks/base_task.py                                                                                       â”‚
â”‚                                                                                                                      â”‚
â”‚  # Line 50-57: Where 'name' comes from                                                                               â”‚
â”‚  datasets_config = cfg.datasets_cfg  # From YAML config                                                              â”‚
â”‚                                                                                                                      â”‚
â”‚  for name in datasets_config:  # name = "mimic" or "openi"                                                           â”‚
â”‚      dataset_config = datasets_config[name]                                                                          â”‚
â”‚      builder = registry.get_builder_class(name)(dataset_config)                                                      â”‚
â”‚      #                                   â†‘                                                                           â”‚
â”‚      #                                   name="mimic" â†’ returns MIMICBuilder                                         â”‚
â”‚      #                                   name="openi" â†’ returns OpenIBuilder                                         â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚                                           ğŸ“ STEP 7: Configuration Source                                            â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚  ğŸ“ train_configs/xraygpt_mimic_pretrain.yaml                                                                        â”‚
â”‚                                                                                                                      â”‚
â”‚  datasets:                                                                                                           â”‚
â”‚    mimic:  # â† This becomes the 'name' parameter                                                                     â”‚
â”‚      vis_processor:                                                                                                  â”‚
â”‚        train:                                                                                                        â”‚
â”‚          name: "blip2_image_train"                                                                                   â”‚
â”‚          image_size: 224                                                                                             â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚                                         ğŸ“ STEP 8: Complete Connection Chain                                         â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚  YAML Config â†’ cfg.datasets_cfg â†’ name="mimic" â†’ registry.get_builder_class("mimic")                                 â”‚
â”‚      â†“                                                                                                               â”‚
â”‚  registry.mapping["builder_name_mapping"]["mimic"] â†’ MIMICBuilder class                                              â”‚
â”‚      â†“                                                                                                               â”‚
â”‚  MIMICBuilder(dataset_config) â†’ MIMICBuilder instance                                                                â”‚
â”‚      â†“                                                                                                               â”‚
â”‚  builder.build_datasets() â†’ Creates MIMICDataset instances                                                           â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚ The key insight: The registry acts as a central lookup table where:                                                  â”‚
â”‚                                                                                                                      â”‚
â”‚  1 Registration phase: @registry.register_builder("mimic") stores MIMICBuilder class with key "mimic"                â”‚
â”‚  2 Lookup phase: registry.get_builder_class("mimic") retrieves the stored MIMICBuilder class                         â”‚
â”‚  3 Instantiation: MIMICBuilder(dataset_config) creates an actual builder instance                                    â”‚
â”‚                                                                                                                      â”‚
â”‚ This pattern allows dynamic class loading based on configuration without hardcoded imports! 


                                                                                        â”‚
â”‚                                   ğŸ”— Exact Code Connection: Registry Model Lookup                                    â”‚
â”‚                                                                                                                      â”‚
â”‚                                    ğŸ“ STEP 1: Registration Phase (During Import)                                     â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚  ğŸ“ xraygpt/models/mini_gpt4.py                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚  # Line 7: Import registry                                                                                           â”‚
â”‚  from xraygpt.common.registry import registry                                                                        â”‚
â”‚                                                                                                                      â”‚
â”‚  # Line 36-37: Register MiniGPT4                                                                                     â”‚
â”‚  @registry.register_model("mini_gpt4")                                                                               â”‚
â”‚  class MiniGPT4(Blip2Base):                                                                                          â”‚
â”‚      # This decorator calls registry.register_model("mini_gpt4")                                                     â”‚
â”‚      # which stores: mapping["model_name_mapping"]["mini_gpt4"] = MiniGPT4                                           â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚                                        ğŸ“ STEP 2: Registry Storage Mechanism                                         â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚  ğŸ“ xraygpt/common/registry.py                                                                                       â”‚
â”‚                                                                                                                      â”‚
â”‚  # Line 82-108: register_model decorator                                                                             â”‚
â”‚  @classmethod                                                                                                        â”‚
â”‚  def register_model(cls, name):                                                                                      â”‚
â”‚      def wrap(model_cls):                                                                                            â”‚
â”‚          # Line 105: Store in mapping                                                                                â”‚
â”‚          cls.mapping["model_name_mapping"][name] = model_cls                                                         â”‚
â”‚          return model_cls                                                                                            â”‚
â”‚      return wrap                                                                                                     â”‚
â”‚                                                                                                                      â”‚
â”‚  # Internal storage after registration:                                                                              â”‚
â”‚  # cls.mapping["model_name_mapping"] = {                                                                             â”‚
â”‚  #     "mini_gpt4": MiniGPT4                                                                                         â”‚
â”‚  # }                                                                                                                 â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚                                      ğŸ“ STEP 3: Lookup Phase (During Training)                                       â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚  ğŸ“ xraygpt/tasks/base_task.py                                                                                       â”‚
â”‚                                                                                                                      â”‚
â”‚  # Line 30-34: build_model method                                                                                    â”‚
â”‚  def build_model(self, cfg):                                                                                         â”‚
â”‚      model_config = cfg.model_cfg                                                                                    â”‚
â”‚                                                                                                                      â”‚
â”‚      model_cls = registry.get_model_class(model_config.arch)                                                         â”‚
â”‚      #           â†“                                                                                                   â”‚
â”‚      #           ğŸ”— CALLS: registry.get_model_class(model_config.arch)                                               â”‚
â”‚                                                                                                                      â”‚
â”‚      return model_cls.from_config(model_config)                                                                      â”‚
â”‚      #      â†“                                                                                                        â”‚
â”‚      #      ğŸ”— CALLS: MiniGPT4.from_config(model_config)                                                             â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚                                         ğŸ“ STEP 4: Registry Lookup Mechanism                                         â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚  ğŸ“ xraygpt/common/registry.py                                                                                       â”‚
â”‚                                                                                                                      â”‚
â”‚  # Line 235-236: get_model_class method                                                                              â”‚
â”‚  @classmethod                                                                                                        â”‚
â”‚  def get_model_class(cls, name):                                                                                     â”‚
â”‚      return cls.mapping["model_name_mapping"].get(name, None)                                                        â”‚
â”‚      #      â†“                                                                                                        â”‚
â”‚      #      ğŸ”— RETURNS:                                                                                              â”‚
â”‚      #         - If name="mini_gpt4" â†’ returns MiniGPT4 class                                                        â”‚
â”‚      #         - If name not found â†’ returns None                                                                    â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚                                            ğŸ“ STEP 5: Model Instantiation                                            â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚  ğŸ“ xraygpt/models/mini_gpt4.py                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚  # Line 337-381: from_config class method                                                                            â”‚
â”‚  @classmethod                                                                                                        â”‚
â”‚  def from_config(cls, cfg):                                                                                          â”‚
â”‚      # Extract config parameters                                                                                     â”‚
â”‚      vit_model = cfg.get("vit_model", "eva_clip_g")                                                                  â”‚
â”‚      q_former_model = cfg.get("q_former_model", "...")                                                               â”‚
â”‚      img_size = cfg.get("image_size")                                                                                â”‚
â”‚      # ... more parameters                                                                                           â”‚
â”‚                                                                                                                      â”‚
â”‚      # Line 357-373: Create model instance                                                                           â”‚
â”‚      model = cls(                                                                                                    â”‚
â”‚          vit_model=vit_model,                                                                                        â”‚
â”‚          q_former_model=q_former_model,                                                                              â”‚
â”‚          img_size=img_size,                                                                                          â”‚
â”‚          # ... all parameters                                                                                        â”‚
â”‚      )                                                                                                               â”‚
â”‚                                                                                                                      â”‚
â”‚      # Line 375-380: Load checkpoint if specified                                                                    â”‚
â”‚      ckpt_path = cfg.get("ckpt", "")                                                                                 â”‚
â”‚      if ckpt_path:                                                                                                   â”‚
â”‚          ckpt = torch.load(ckpt_path, map_location="cpu")                                                            â”‚
â”‚          msg = model.load_state_dict(ckpt['model'], strict=False)                                                    â”‚
â”‚                                                                                                                      â”‚
â”‚      return model                                                                                                    â”‚
â”‚      #      â†“                                                                                                        â”‚
â”‚      #      ğŸ”— RETURNS: Fully initialized MiniGPT4 instance                                                          â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚                                        ğŸ“ STEP 6: Complete Flow Visualization                                        â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚  # REGISTRATION FLOW (happens during import):                                                                        â”‚
â”‚  train.py                                                                                                            â”‚
â”‚  â”œâ”€â”€ Line 28: from xraygpt.models import *                                                                           â”‚
â”‚  â”‚   â””â”€â”€ ğŸ”— IMPORTS: xraygpt/models/mini_gpt4.py                                                                     â”‚
â”‚  â”‚       â””â”€â”€ Line 36: @registry.register_model("mini_gpt4")                                                          â”‚
â”‚  â”‚           â””â”€â”€ ğŸ”— STORES: registry.mapping["model_name_mapping"]["mini_gpt4"] = MiniGPT4                           â”‚
â”‚                                                                                                                      â”‚
â”‚  # LOOKUP FLOW (happens during training):                                                                            â”‚
â”‚  train.py                                                                                                            â”‚
â”‚  â””â”€â”€ Line 93: model = task.build_model(cfg)                                                                          â”‚
â”‚      â””â”€â”€ ğŸ”— CALLS: xraygpt/tasks/base_task.py::build_model()                                                         â”‚
â”‚          â”œâ”€â”€ Line 32: model_config = cfg.model_cfg                                                                   â”‚
â”‚          â”œâ”€â”€ Line 33: model_cls = registry.get_model_class(model_config.arch)                                        â”‚
â”‚          â”‚   â””â”€â”€ ğŸ”— CALLS: registry.get_model_class("mini_gpt4")                                                     â”‚
â”‚          â”‚       â””â”€â”€ ğŸ”— RETURNS: MiniGPT4 class from mapping["model_name_mapping"]["mini_gpt4"]                      â”‚
â”‚          â”‚                                                                                                           â”‚
â”‚          â””â”€â”€ Line 34: return model_cls.from_config(model_config)                                                     â”‚
â”‚              â””â”€â”€ ğŸ”— CALLS: MiniGPT4.from_config(model_config)                                                        â”‚
â”‚                  â””â”€â”€ ğŸ”— RETURNS: Initialized MiniGPT4 instance                                                       â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚                                  ğŸ“ STEP 7: The model_config.arch Parameter Source                                   â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚  ğŸ“ xraygpt/tasks/base_task.py                                                                                       â”‚
â”‚                                                                                                                      â”‚
â”‚  # Line 31-32: Where 'arch' comes from                                                                               â”‚
â”‚  model_config = cfg.model_cfg  # From YAML config                                                                    â”‚
â”‚  model_cls = registry.get_model_class(model_config.arch)                                                             â”‚
â”‚  #                                    â†‘                                                                              â”‚
â”‚  #                                    model_config.arch = "mini_gpt4"                                                â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚                                           ğŸ“ STEP 8: Configuration Source                                            â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚  ğŸ“ train_configs/xraygpt_mimic_pretrain.yaml                                                                        â”‚
â”‚                                                                                                                      â”‚
â”‚  model:                                                                                                              â”‚
â”‚    arch: mini_gpt4  # â† This becomes model_config.arch                                                               â”‚
â”‚    model_type: pretrain_vicuna                                                                                       â”‚
â”‚    freeze_vit: True                                                                                                  â”‚
â”‚    freeze_qformer: True                                                                                              â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚                                         ğŸ“ STEP 9: Complete Connection Chain                                         â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚  YAML Config â†’ cfg.model_cfg â†’ model_config.arch="mini_gpt4"                                                         â”‚
â”‚      â†“                                                                                                               â”‚
â”‚  registry.get_model_class("mini_gpt4")                                                                               â”‚
â”‚      â†“                                                                                                               â”‚
â”‚  registry.mapping["model_name_mapping"]["mini_gpt4"] â†’ MiniGPT4 class                                                â”‚
â”‚      â†“                                                                                                               â”‚
â”‚  MiniGPT4.from_config(model_config) â†’ Creates MiniGPT4 instance                                                      â”‚
â”‚      â†“                                                                                                               â”‚
â”‚  Loads checkpoint, initializes components â†’ Fully configured model                                                   â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚                                   ğŸ“ STEP 10: Key Differences from Builder Pattern                                   â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚  # Builder Pattern (Datasets):                                                                                       â”‚
â”‚  builder = registry.get_builder_class(name)(dataset_config)  # Direct instantiation                                  â”‚
â”‚  dataset = builder.build_datasets()                          # Then call build method                                â”‚
â”‚                                                                                                                      â”‚
â”‚  # Model Pattern:                                                                                                    â”‚
â”‚  model_cls = registry.get_model_class(model_config.arch)     # Get class                                             â”‚
â”‚  model = model_cls.from_config(model_config)                # Use factory method                                     â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚ The key insight: The model registration follows the same registry pattern as builders, but uses a factory method     â”‚
â”‚ (from_config) instead of direct instantiation. This allows for:                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚  1 Complex initialization: Loading pretrained weights, setting up multiple components                                â”‚
â”‚  2 Configuration parsing: Converting YAML config to model parameters                                                 â”‚
â”‚  3 Conditional setup: Different initialization based on config flags                                                 â”‚
â”‚                                                                                                                      â”‚
â”‚ The registry acts as the central dispatcher that maps string identifiers to actual Python classes!   
